{"version":3,"sources":["../../src/pages/chat-single/chat-single.module.ts","../../src/pages/chat-single/chat-single.ts"],"names":[],"mappings":"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","file":"21.js","sourcesContent":["import { NgModule } from '@angular/core';\r\nimport { IonicPageModule } from 'ionic-angular';\r\nimport { ChatSinglePage } from './chat-single';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    ChatSinglePage,\r\n  ],\r\n  imports: [\r\n    IonicPageModule.forChild(ChatSinglePage),\r\n  ],\r\n})\r\nexport class ChatSinglePageModule {}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/chat-single/chat-single.module.ts","import { Component, ElementRef, ViewChild } from '@angular/core';\r\nimport { FormGroup, FormControl, Validators } from '@angular/forms';\r\nimport { IonicPage, NavController, NavParams, ToastController, Content, LoadingController } from 'ionic-angular';\r\nimport * as firebase from 'firebase';\r\nimport { ChatProvider } from '../../providers/chat/chat';\r\nimport 'firebase/firestore';\r\n\r\n@IonicPage()\r\n@Component({\r\n  selector: 'page-chat-single',\r\n  templateUrl: 'chat-single.html',\r\n})\r\nexport class ChatSinglePage {\r\n  db: any = firebase.firestore();\r\n  receiverEmail: string;\r\n  receiverName: string;\r\n  receiverPhoto: string;\r\n  userEmail: string;\r\n  userId: string;\r\n  userEmailName: string;\r\n  userPhoto: string;\r\n  chatTxt: string;\r\n  chatTxtCtrl: FormControl;\r\n  chatForm: FormGroup;\r\n  chats: any;\r\n  chatId: string;\r\n  userName: string;\r\n  pageLoaded: boolean = false;\r\n  @ViewChild(Content) content: Content;\r\n\r\n  constructor(\r\n    public navCtrl: NavController, \r\n    public navParams: NavParams,\r\n    public toastCtrl: ToastController,\r\n    public loadingCtrl: LoadingController,\r\n    public chatProvider: ChatProvider\r\n  ) {\r\n    this.chatTxtCtrl = new FormControl('', Validators.required);\r\n    this.chatForm = new FormGroup({\r\n      chatTxt: this.chatTxtCtrl\r\n    });\r\n\r\n    this.userEmail = localStorage.getItem('email');\r\n    this.userId = localStorage.getItem('userId');\r\n    this.userEmailName = localStorage.getItem('email').split('@')[0].replace('.','').toLowerCase();\r\n    console.log('this.userEmailName', this.userEmailName);\r\n    this.getChatReceiverInfo(this.navParams.data['uid']);\r\n    this.scrollToBottom();\r\n    \r\n  }\r\n\r\n  ionViewDidLoad() {\r\n    this.getSenderPhoto();\r\n  }\r\n\r\n  markAsRead() {\r\n    this.db.collection('chats').doc(this.chatId).collection('messages').get().then(res => {\r\n      let unreadCount = 0;\r\n      let data = res.docs.filter(messageData => {\r\n        console.log('wwwwww', messageData.data().userEmailName);\r\n        return messageData.data().userEmailName.toLowerCase() != this.userEmailName\r\n      }).map(filterData => {\r\n        unreadCount++;\r\n        \r\n        this.db.collection('chats').doc(this.chatId).collection('messages').doc(filterData.id).update({\r\n          isRead: 1\r\n        });\r\n      });\r\n\r\n      let notifRef = firebase.database().ref(`notif/chats/${this.userEmailName}`);\r\n      notifRef.once('value', snapshot => {\r\n        if(snapshot.hasChild('unread')) {\r\n          let unread = snapshot.val().unread - unreadCount;\r\n          if(unread < 0) {\r\n            notifRef.set({\r\n              unread: 0\r\n            });\r\n          }else {\r\n            notifRef.set({\r\n              unread: unread\r\n            });\r\n          }\r\n        }else {\r\n          notifRef.set({\r\n            unread: 0\r\n          });\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  scrollToBottom() {\r\n    setTimeout(() => {\r\n      this.content.scrollToBottom();\r\n    }, 300);\r\n\r\n    setTimeout(() => {\r\n      this.content.scrollToBottom();\r\n    }, 2000);\r\n  }\r\n\r\n  getSenderPhoto() {\r\n    this.db.collection('users').doc(this.userId).get().then(res => {\r\n      let sender = res.data();\r\n      this.userPhoto = sender.photo;\r\n      this.userName = sender.name;\r\n      if(this.userPhoto == null || this.userPhoto == '') {\r\n        this.userPhoto = '';\r\n      }\r\n    }).catch(err => {\r\n      let toast = this.toastCtrl.create({\r\n        message: err.message,\r\n        duration: 3000,\r\n        position: 'top'\r\n      });\r\n\r\n      toast.present();\r\n    });\r\n  }\r\n\r\n  getChatReceiverInfo(uid) {\r\n    this.db.collection('users').doc(uid).get().then(res => {\r\n      let receiver = res.data();\r\n      this.receiverEmail = receiver.email.toLowerCase();\r\n      this.receiverName = receiver.name;\r\n      console.log('this.receiverName', this.receiverName);\r\n      this.receiverPhoto = receiver.photo;\r\n      let senderName = this.userEmail.split('@')[0].replace('.','');\r\n      let recName = this.receiverEmail.split('@')[0].replace('.','');\r\n      this.chatId = senderName < recName ? senderName+'-'+recName : recName+'-'+senderName;\r\n      this.loadChatConversation();\r\n      this.markAsRead();\r\n    }).catch(err => {\r\n      let toast = this.toastCtrl.create({\r\n        message: err.message,\r\n        duration: 3000,\r\n        position: 'top'\r\n      });\r\n\r\n      toast.present();\r\n    });\r\n  }\r\n\r\n  back() {\r\n    this.navCtrl.pop();\r\n  }\r\n\r\n  loadChatConversation() {\r\n    this.db.collection('chats').doc(this.chatId).collection('messages').orderBy(\"dateAdded\", \"asc\").limit(1000).onSnapshot(res => {\r\n      let data = res.docs.map(doc => doc.data());\r\n      this.chats = data;\r\n      this.pageLoaded = true;\r\n    })\r\n  }\r\n\r\n  chatSubmit() {\r\n    if(this.chatForm.valid) {\r\n      let timeStampSec = new Date().getTime() / 1000;\r\n      let payload = {\r\n        message: this.chatTxt,\r\n        isPhoto: false,\r\n        name: this.userName,\r\n        userEmailName: this.userEmailName,\r\n        photo: this.userPhoto,\r\n        isRead: 0,\r\n        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),\r\n        timestampInSecs: timeStampSec\r\n      };\r\n      this.chatTxt = '';\r\n\r\n      this.db.collection('chats').doc(this.chatId).set({ // Add this to have doc field id\r\n        docId: this.chatId\r\n      });\r\n\r\n      let receiverEmailName = this.receiverEmail.split('@')[0].replace('.','').toLowerCase();\r\n      let notifRef = firebase.database().ref(`notif/chats/${receiverEmailName}`);\r\n      notifRef.once('value', snapshot => {\r\n        console.log('firing')\r\n        if(snapshot.hasChild('unread')) {\r\n        let unread = snapshot.val().unread + 1;\r\n        notifRef.set({\r\n          unread: unread\r\n        });\r\n        }else {\r\n          notifRef.set({\r\n            unread: 1\r\n          });\r\n        }\r\n      });\r\n\r\n      this.db.collection('chats').doc(this.chatId).collection('messages').add(payload).then(() => {\r\n        this.scrollToBottom();\r\n      }).catch(err => {\r\n        let toast = this.toastCtrl.create({\r\n          message: err.message,\r\n          duration: 3000,\r\n          position: 'top'\r\n        });\r\n    \r\n        toast.present();\r\n      });\r\n\r\n    }else {\r\n      let toast = this.toastCtrl.create({\r\n        message: 'Message is required in able to send!',\r\n        duration: 3000,\r\n        position: 'top'\r\n      });\r\n\r\n      toast.present();\r\n    }\r\n  }\r\n\r\n  sendPhoto(event) {\r\n    let loading = this.loadingCtrl.create({\r\n      content: 'Sending photo, please wait...'\r\n    });\r\n  \r\n    loading.present();\r\n\r\n    let imageType = ['image/gif', 'image/png', 'image/jpeg', 'image/bmp', 'image/webp'];\r\n    if (imageType.indexOf(event.target.files.item(0)['type']) != -1) {\r\n      this.chatProvider.uploadPhoto(event.target.files.item(0), this.chatId, this.userName, this.userEmailName,  this.userPhoto).then(photo => {\r\n        loading.dismiss();\r\n        this.scrollToBottom();\r\n      }).catch(err => {\r\n        loading.dismiss();\r\n        let toast = this.toastCtrl.create({\r\n          message: err.message,\r\n          duration: 3000,\r\n          position: 'top'\r\n        });\r\n\r\n        toast.present();\r\n      });\r\n    }else {\r\n      loading.dismiss();\r\n      let toast = this.toastCtrl.create({\r\n        message: 'Invalid file type, only allowed file types are gif, png, jpeg, bmp, webp',\r\n        duration: 3000,\r\n        position: 'top'\r\n      });\r\n\r\n      toast.present();\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/chat-single/chat-single.ts"],"sourceRoot":""}